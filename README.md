# ğŸš€ HSI HFT V3 - æ¸¯è‚¡ETFé«˜é¢‘äº¤æ˜“ç³»ç»Ÿ

<div align="center">

![Python](https://img.shields.io/badge/Python-3.10+-blue.svg)
![PyTorch](https://img.shields.io/badge/PyTorch-2.0+-red.svg)
![License](https://img.shields.io/badge/License-MIT-green.svg)
![Status](https://img.shields.io/badge/Status-Production_Ready-brightgreen.svg)

**åŸºäº Mamba + VICReg çš„æ·±åº¦å¼ºåŒ–å­¦ä¹ äº¤æ˜“ç³»ç»Ÿ**

[æ ¸å¿ƒç‰¹æ€§](#-æ ¸å¿ƒç‰¹æ€§) â€¢ [å¿«é€Ÿå¼€å§‹](#-å¿«é€Ÿå¼€å§‹) â€¢ [ç³»ç»Ÿæ¶æ„](#-ç³»ç»Ÿæ¶æ„) â€¢ [V3 æ¶æ„](#-v3-æ¶æ„è¯¦è§£)

</div>

---

## ğŸ“– é¡¹ç›®ç®€ä»‹

**HSI HFT V3** æ˜¯ä¸€ä¸ª**ç”Ÿäº§çº§é«˜é¢‘äº¤æ˜“ç ”ç©¶å¹³å°**ï¼Œä¸“æ³¨äºæ¸¯è‚¡ETFï¼ˆæ’ç”ŸETF sz159920 / æ’ç”ŸHè‚¡ETF sh513130ï¼‰çš„ç»Ÿè®¡å¥—åˆ©ç­–ç•¥ã€‚V3 ç‰ˆæœ¬é‡‡ç”¨å…¨æ–°çš„æ¨¡å—åŒ–æ¶æ„ï¼Œå®ç°äº†ä»æ•°æ®é‡‡é›†ã€æ·±åº¦å­¦ä¹ å»ºæ¨¡ã€ç­–ç•¥å›æµ‹åˆ°æ€§èƒ½è¯„ä¼°çš„å®Œæ•´é—­ç¯ã€‚

### ğŸ¯ äº¤æ˜“ç­–ç•¥

- **æ ‡çš„**: æ¸¯è‚¡ETFåŒæµå¥—åˆ©ï¼ˆæ²ªæ·±äº¤æ˜“æ‰€ï¼‰
- **é¢‘ç‡**: è¶…é«˜é¢‘ï¼ˆ3ç§’çº§Kçº¿ï¼‰
- **æ¨¡å¼**: L1 Takeræ‰§è¡Œï¼ˆå¯¹æ‰‹ä»·æˆäº¤ï¼‰
- **çº¦æŸ**: Long-onlyï¼ˆAè‚¡é™åˆ¶ï¼‰
- **é¢„æµ‹çª—å£**: H* = 120ç§’ï¼ˆ40ä¸ªbarï¼‰
- **å»¶è¿Ÿæ¨¡æ‹Ÿ**: 1ä¸ªbarï¼ˆ3ç§’ï¼‰

### ğŸ† V3 æ ¸å¿ƒäº®ç‚¹

- âœ… **Mambaæ¶æ„**: Selective State Space Model + FiLMèåˆ
- âœ… **VICRegé¢„è®­ç»ƒ**: è‡ªç›‘ç£å­¦ä¹ æå‡ç‰¹å¾è´¨é‡
- âœ… **Dual-Stream**: Target + Auxiliary åŒæµå»ºæ¨¡
- âœ… **ç¦»æ•£æ—¶é—´ç”Ÿå­˜åˆ†æ**: Hazard + Competing Risk
- âœ… **ç™½ç›’+é»‘ç›’**: å¯è§£é‡ŠåŸºçº¿ + æ·±åº¦ä¿®æ­£
- âœ… **äº‹ä»¶é©±åŠ¨å›æµ‹**: é—­ç¯å»¶è¿Ÿæ¨¡æ‹Ÿ + æµåŠ¨æ€§æ£€æŸ¥
- âœ… **æ¨¡å—åŒ–æ¶æ„**: 3å±‚æ•´åˆè®¾è®¡ï¼Œæ˜“ç»´æŠ¤ã€æ˜“æ‰©å±•

---

## ğŸ”¥ æ ¸å¿ƒç‰¹æ€§

### 1. V3 æ•´åˆæ¶æ„

é¡¹ç›®é‡‡ç”¨**ä¸‰å±‚æ¨¡å—åŒ–è®¾è®¡**ï¼Œä»14ä¸ªæ–‡ä»¶ç²¾ç®€ä¸º8ä¸ªæ ¸å¿ƒæ–‡ä»¶ï¼š

```python
# æ•°æ®å±‚ (data_layer.py)
from hsi_hft_v3.data_layer import V5DataLoader, Bar, AlignedSample

# äº¤æ˜“å±‚ (trading_layer.py)
from hsi_hft_v3.trading_layer import StateMachine, BacktestEngine, PolicyConfig

# æ¨¡å‹å±‚ (model_layer.py)
from hsi_hft_v3.model_layer import DeepFactorMinerV5, ResidualCombine

# ç‰¹å¾å·¥ç¨‹ (ç‹¬ç«‹)
from hsi_hft_v3.features.whitebox import WhiteBoxFeatureFactory
```

**ä¼˜åŠ¿**:
- ğŸ“¦ **50%æ–‡ä»¶å‡å°‘**: 14 â†’ 8 ä¸ªæ–‡ä»¶
- ğŸ¯ **æ¸…æ™°èŒè´£**: æ¯å±‚ä¸“æ³¨å•ä¸€æŠ½è±¡
- ğŸ”„ **ä½è€¦åˆ**: å•å‘ä¾èµ–ï¼Œæ— å¾ªç¯
- ğŸ“ **æ˜“ç»´æŠ¤**: ç›¸å…³åŠŸèƒ½é›†ä¸­ç®¡ç†

### 2. æ·±åº¦å› å­æŒ–æ˜ (DeepFactorMinerV5)

```
æ¶æ„:
Input (B, 100, 3)          # Batch Ã— Lookback Ã— Features
    â”‚
    â”œâ”€â†’ [Target Stream]
    â”‚   â”œâ”€ LocalLOBEncoder (1D CNN)
    â”‚   â””â”€ SelectiveSSM (Mamba)
    â”‚
    â”œâ”€â†’ [Auxiliary Stream]
    â”‚   â”œâ”€ LocalLOBEncoder (1D CNN)
    â”‚   â””â”€ SelectiveSSM (Mamba)
    â”‚
    â””â”€â†’ FiLM Fusion (Feature-wise Modulation)
         â”‚
         â””â”€â†’ Projector â†’ 32-dim Latent Factors
```

**ç‰¹ç‚¹**:
- ğŸ”¬ **Mambaæ ¸å¿ƒ**: çº¯PyTorchå®ç°ï¼Œæ”¯æŒWindows/CPU
- ğŸ­ **åŒæµå»ºæ¨¡**: Target (159920) + Aux (513130)
- ğŸ§¬ **FiLMèåˆ**: è¾…åŠ©æµè°ƒåˆ¶ç›®æ ‡æµ
- ğŸ“Š **VICRegæ­£åˆ™**: æ–¹å·®-åæ–¹å·®è§£è€¦

### 3. é¢„æµ‹å¤´ç³»ç»Ÿ

```python
# ä¸‰å¤´é¢„æµ‹
class ResidualCombine:
    def forward(white_feats, deep_factors):
        # ç™½ç›’åŸºçº¿
        base_hit = white_linear(white_feats)
        base_hazard = white_linear(white_feats)
        base_risk = white_linear(white_feats)
        
        # é»‘ç›’ä¿®æ­£
        delta_hit = black_linear(deep_factors)
        delta_hazard = black_linear(deep_factors)
        delta_risk = black_linear(deep_factors)
        
        # æ®‹å·®ç»„åˆ
        return base + delta
```

**è¾“å‡º**:
- **P(Hit)**: æ˜¯å¦åœ¨120ç§’å†…ç›ˆåˆ©
- **P(Ï„â‰¤60s)**: åœ¨60ç§’å†…å®Œæˆçš„æ¦‚ç‡
- **P(Risk)**: å¯¹æ‰‹é£é™©ï¼ˆé€†å‘ä»·æ ¼ç§»åŠ¨ï¼‰

### 4. çŠ¶æ€æœºç­–ç•¥

```
States: FLAT â†’ LONG â†’ COOLDOWN â†’ FLAT

Transitions:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  Entry Signal   â”Œâ”€â”€â”€â”€â”€â”€â”  Exit Signal   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FLAT   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚ LONG â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚ COOLDOWN â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†‘                                                      â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    Cooldown æœŸæ»¡
```

**Entry Gates** (é€‚åº”æ€§é˜ˆå€¼):
- With Aux: `p_hit â‰¥ 0.51` & `p_Ï„â‰¤60s â‰¥ 0.50` & `risk â‰¤ 0.40`
- No Aux: `p_hit â‰¥ 0.70` & `p_Ï„â‰¤60s â‰¥ 0.80` & `risk â‰¤ 0.10`
- Whitebox: `spread_bps â‰¤ 10` & `depth â‰¥ 5000` & `vpin_z â‰¤ 3.0`

**Exit Triggers**:
- Max Hold: 40 bars (120ç§’)
- Risk Threshold: `risk > 0.25`
- Micro Reversal: `vpin_z > 3.5` æˆ– `kyle_z > 3.0`

### 5. äº‹ä»¶é©±åŠ¨å›æµ‹

```python
BacktestEngine:
    for each sample:
        1. æ£€æŸ¥å»¶è¿Ÿé˜Ÿåˆ— â†’ æ‰§è¡Œåˆ°æœŸè®¢å•
        2. ç­–ç•¥å†³ç­– â†’ ç”Ÿæˆæ–°è®¢å•
        3. è®¢å•å…¥é˜Ÿ (t + latency)
        4. Mark-to-Market
        5. è®°å½•å‡€å€¼æ›²çº¿
```

**ç‰¹ç‚¹**:
- â±ï¸ **å»¶è¿Ÿæ¨¡æ‹Ÿ**: 1-bar delay (3ç§’)
- ğŸ’§ **æµåŠ¨æ€§æ£€æŸ¥**: L1 All-or-None filling
- ğŸ’° **æˆæœ¬æ¨¡å‹**: 1bp å•è¾¹ + æ»‘ç‚¹ï¼ˆå¯é€‰ï¼‰
- ğŸ“Š **é—­ç¯åé¦ˆ**: Fill/Reject è§¦å‘çŠ¶æ€è½¬ç§»

---

## ğŸ—ï¸ V3 æ¶æ„è¯¦è§£

### æ¨¡å—åˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Main Scripts (Entry Points)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚pipeline_main â”‚  train_v3    â”‚ pretrain_v3  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚              â”‚              â”‚
          â–¼              â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Model Layer                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ DeepFactorMinerV5 (Mamba + FiLM)           â”‚   â”‚
â”‚  â”‚ ResidualCombine (White + Black Fusion)     â”‚   â”‚
â”‚  â”‚ VICReg Loss (Self-Supervised)              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Feature Engineering                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ WhiteBoxFeatureFactory                      â”‚   â”‚
â”‚  â”‚ - 19 Base Factors (Micro/Flow/Future/Cross)â”‚   â”‚
â”‚  â”‚ - Derivative Rules (Z-score + Slope)       â”‚   â”‚
â”‚  â”‚ - 114 Derived Features                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Trading Layer                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ StateMachine (FLAT/LONG/COOLDOWN)          â”‚   â”‚
â”‚  â”‚ BacktestEngine (Event-Driven)              â”‚   â”‚
â”‚  â”‚ Metrics Calculator (Sharpe/DD/PnL)         â”‚   â”‚
â”‚  â”‚ Config Management (Params/Constants)       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Data Layer                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ V5DataLoader (Multi-Day Loading)           â”‚   â”‚
â”‚  â”‚ BarBuilder (Tick â†’ 3s Bars)                â”‚   â”‚
â”‚  â”‚ DualStreamAligner (Causal Alignment)       â”‚   â”‚
â”‚  â”‚ Data Contract (Bar/AlignedSample)          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµ

```
Raw CSV Files
   â”‚
   â”œâ”€â†’ V5DataLoader.load_date_range()
   â”‚      â”‚
   â”‚      â”œâ”€â†’ BarBuilder.process_dataframe()
   â”‚      â”‚      â””â”€â†’ Forward-fill slow variables
   â”‚      â”‚      â””â”€â†’ Aggregate to 3s bars
   â”‚      â”‚      â””â”€â†’ Sanity check
   â”‚      â”‚
   â”‚      â””â”€â†’ DualStreamAligner.align()
   â”‚             â””â”€â†’ Asof join (max_lag=30s)
   â”‚             â””â”€â†’ AlignedSample(target, aux, masks)
   â”‚
   â””â”€â†’ WhiteBoxFeatureFactory.compute()
          â””â”€â†’ 19 Base Factors + 114 Derived Features
          
   â””â”€â†’ DeepFactorMinerV5.forward()
          â””â”€â†’ 32-dim Latent Factors
          
   â””â”€â†’ ResidualCombine.forward()
          â””â”€â†’ Logits (Hit/Hazard/Risk)
          
   â””â”€â†’ StateMachine.decide()
          â””â”€â†’ Action (HOLD/ENTER_LONG/EXIT_LONG)
          
   â””â”€â†’ BacktestEngine.run()
          â””â”€â†’ Trades + Equity Curve
          
   â””â”€â†’ calculate_metrics()
          â””â”€â†’ Sharpe, Max DD, PnL
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

```bash
Python >= 3.10
PyTorch >= 2.0 (CUDA 11.8+ å¯é€‰)
```

### å®‰è£…ä¾èµ–

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/yourusername/hsi-hft.git
cd hsi-hft

# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# å®‰è£…äº¤æ˜“æ—¥å†ï¼ˆå¯é€‰ï¼‰
pip install exchange-calendars
```

### 1ï¸âƒ£ æ•°æ®é‡‡é›†

```bash
# å¯åŠ¨æ™ºèƒ½è°ƒåº¦å™¨ï¼ˆè‡ªåŠ¨åœ¨äº¤æ˜“æ—¶æ®µé‡‡é›†ï¼‰
python getdata.py

# è¾“å‡º: data/sz159920/*.csv, data/sh513130/*.csv
```

**è°ƒåº¦å™¨ç‰¹æ€§**:
- ğŸ“… è‡ªåŠ¨æ£€æµ‹ Aè‚¡ âˆ© æ¸¯è‚¡ äº¤æ˜“æ—¥
- â° çª—å£åŒ–é‡‡é›† (T1: æ—©ç›˜, T2: åˆé—´, T3: åˆç›˜)
- ğŸ”„ ä¼˜é›…çš„å¯åŠ¨/åœæ­¢æœºåˆ¶

### 2ï¸âƒ£ é¢„è®­ç»ƒç¼–ç å™¨ï¼ˆå¯é€‰ï¼‰

```bash
# VICReg è‡ªç›‘ç£é¢„è®­ç»ƒ
python hsi_hft_v3/pretrain_v3.py

# è¾“å‡º: checkpoints/v3_encoder_pretrained.pth
```

**è®­ç»ƒç›®æ ‡**:
- é¢„æµ‹æœªæ¥çŠ¶æ€ (JEPA-style)
- VICReg æ­£åˆ™åŒ–ï¼ˆæ–¹å·®+åæ–¹å·®ï¼‰

### 3ï¸âƒ£ è®­ç»ƒæ¨¡å‹

```bash
# ç›‘ç£å­¦ä¹ è®­ç»ƒ
python hsi_hft_v3/train_v3.py

# è¾“å‡º: checkpoints/v3_model_latest.pth
```

**Losså‡½æ•°**:
```python
L_total = L_hit + 0.5*L_hazard + 0.5*L_risk + 0.1*L_consistency
```

### 4ï¸âƒ£ è¿è¡Œå›æµ‹

```bash
# æ¨ç† + å›æµ‹
python hsi_hft_v3/pipeline_main.py

# è¾“å‡º: äº¤æ˜“è®°å½• + æ€§èƒ½æŒ‡æ ‡
```

**ç¤ºä¾‹è¾“å‡º**:
```
=== V3 System Report ===
n_trades: 234
n_skips: 12
total_pnl: 5234.56
total_ret_pct: 2.617
sharpe: 1.23
max_drawdown_pct: -8.45
fill_rate_pct: 95.1
```

---

## ğŸ“Š æ•°æ®æ ¼å¼

### åŸå§‹ Tick æ•°æ®

```csv
tx_local_time,price,tick_vol,tick_amt,bp1,bv1,sp1,sv1,...
1704876000123,4.321,1000,4321.0,4.320,5000,4.322,4800,...
```

### 3ç§’ Bar æ•°æ®

```python
@dataclass
class Bar:
    ts_ms: int              # æ—¶é—´æˆ³
    symbol: str             # ä»£ç 
    mid: float              # ä¸­é—´ä»·
    vwap: float             # æˆäº¤å‡ä»·
    volume: int             # æˆäº¤é‡
    bids: List[tuple]       # 5æ¡£ä¹°ç›˜
    asks: List[tuple]       # 5æ¡£å–ç›˜
    sentiment: float        # æƒ…ç»ªæŒ‡æ ‡
    premium_rate: float     # æº¢ä»·ç‡
    iopv: float             # IOPV
    fut_price: float        # æœŸè´§ä»·æ ¼(å¯é€‰)
    fut_imb: float          # æœŸè´§ä¸å¹³è¡¡(å¯é€‰)
```

### å¯¹é½æ ·æœ¬

```python
@dataclass
class AlignedSample:
    ts_ms: int
    target: Bar             # ç›®æ ‡ETF (159920)
    aux: Bar                # è¾…åŠ©ETF (513130)
    aux_available: bool     # è¾…åŠ©æ•°æ®æ˜¯å¦æœ‰æ•ˆ
    aux_lag_ms: int         # æ—¶é—´å·®
    has_fut: bool           # æ˜¯å¦æœ‰æœŸè´§æ•°æ®
```

---

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

| ç±»åˆ« | æŠ€æœ¯ |
|------|------|
| **æ·±åº¦å­¦ä¹ ** | PyTorch 2.0+, Mamba (Selective SSM) |
| **è‡ªç›‘ç£** | VICReg, JEPA |
| **æ•°æ®å¤„ç†** | Pandas, NumPy |
| **å¼‚æ­¥IO** | asyncio, aiohttp |
| **æµè§ˆå™¨è‡ªåŠ¨åŒ–** | Playwright |
| **äº¤æ˜“æ—¥å†** | exchange_calendars |
| **å›æµ‹** | è‡ªç ”äº‹ä»¶é©±åŠ¨å¼•æ“ |

---

## ğŸ“ˆ æ€§èƒ½åŸºå‡†

### æ¨¡å‹æ€§èƒ½

```
æ¨¡å‹: DeepFactorMinerV5 + ResidualCombine
å‚æ•°é‡: ~1.5M
è®­ç»ƒé›†: 2024å¹´11-12æœˆ
éªŒè¯é›†: å‡†ç¡®ç‡ 54.2%

âš ï¸ æ³¨æ„: 
- å‡†ç¡®ç‡ > 50% å³å¯ç›ˆåˆ©ï¼ˆé…åˆé£æ§ï¼‰
- å…³é”®åœ¨äº P(Hit|pred=1) çš„ç²¾ç¡®ç‡
```

### å›æµ‹ç»“æœï¼ˆç¤ºä¾‹ï¼‰

```
æ—¥æœŸèŒƒå›´: 2024-12-01 ~ 2024-12-31
åˆå§‹èµ„é‡‘: 1,000,000 CNY
å•ç¬”äº¤æ˜“: 1,000è‚¡
æˆæœ¬: 1bp åŒè¾¹

ç»“æœ:
- äº¤æ˜“æ¬¡æ•°: 234 ç¬”
- æˆåŠŸç‡: 58.1%
- æ€»æ”¶ç›Š: +2.62%
- Sharpe: 1.23
- Max DD: -8.45%
- æˆäº¤ç‡: 95.1%
```

---

## ğŸ“‚ é¡¹ç›®ç»“æ„

```
hsi/
â”œâ”€â”€ hsi_hft_v3/                    # V3 æ ¸å¿ƒç³»ç»Ÿ
â”‚   â”œâ”€â”€ data_layer.py              # æ•°æ®å±‚ (340è¡Œ)
â”‚   â”‚   â”œâ”€ Bar, AlignedSample      #   æ•°æ®å¥‘çº¦
â”‚   â”‚   â”œâ”€ BarBuilder              #   Kçº¿æ„å»º
â”‚   â”‚   â”œâ”€ DualStreamAligner       #   åŒæµå¯¹é½
â”‚   â”‚   â””â”€ V5DataLoader            #   æ•°æ®åŠ è½½
â”‚   â”‚
â”‚   â”œâ”€â”€ trading_layer.py           # äº¤æ˜“å±‚ (430è¡Œ)
â”‚   â”‚   â”œâ”€ Config Management       #   é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€ StateMachine            #   çŠ¶æ€æœºç­–ç•¥
â”‚   â”‚   â”œâ”€ BacktestEngine          #   å›æµ‹å¼•æ“
â”‚   â”‚   â””â”€ calculate_metrics       #   æ€§èƒ½æŒ‡æ ‡
â”‚   â”‚
â”‚   â”œâ”€â”€ model_layer.py             # æ¨¡å‹å±‚ (390è¡Œ)
â”‚   â”‚   â”œâ”€ SelectiveSSM            #   Mambaæ ¸å¿ƒ
â”‚   â”‚   â”œâ”€ DeepFactorMinerV5       #   æ·±åº¦æŒ–æ˜
â”‚   â”‚   â”œâ”€ ResidualCombine         #   ç™½+é»‘èåˆ
â”‚   â”‚   â””â”€ vicreg_loss             #   VICRegæŸå¤±
â”‚   â”‚
â”‚   â”œâ”€â”€ features/                  # ç‰¹å¾å·¥ç¨‹
â”‚   â”‚   â””â”€â”€ whitebox.py            #   19å› å­+114è¡ç”Ÿ
â”‚   â”‚
â”‚   â”œâ”€â”€ pipeline_main.py           # æ¨ç†ä¸»è„šæœ¬
â”‚   â”œâ”€â”€ train_v3.py                # è®­ç»ƒè„šæœ¬
â”‚   â””â”€â”€ pretrain_v3.py             # é¢„è®­ç»ƒè„šæœ¬
â”‚
â”œâ”€â”€ getdata/                       # æ•°æ®é‡‡é›†æ¨¡å—
â”‚   â”œâ”€â”€ main.py                   # ä¸»å…¥å£
â”‚   â”œâ”€â”€ clock.py                  # æ—¶é’Ÿç®¡ç†
â”‚   â”œâ”€â”€ event_bus.py              # äº‹ä»¶æ€»çº¿
â”‚   â”œâ”€â”€ aggregator.py             # æ•°æ®èšåˆ
â”‚   â””â”€â”€ sources/                  # å¤šæºæ’ä»¶
â”‚       â”œâ”€â”€ tencent.py            #   è…¾è®¯è´¢ç»
â”‚       â”œâ”€â”€ sina.py               #   æ–°æµªè´¢ç»
â”‚       â””â”€â”€ baidu.py              #   ç™¾åº¦è‚¡å¸‚é€š
â”‚
â”œâ”€â”€ data/                         # å†å²æ•°æ®
â”‚   â”œâ”€â”€ sz159920/                # æ’ç”ŸETF
â”‚   â””â”€â”€ sh513130/                # æ’ç”ŸHè‚¡ETF
â”‚
â”œâ”€â”€ checkpoints/                  # æ¨¡å‹æƒé‡
â”œâ”€â”€ getdata.py                    # æ™ºèƒ½è°ƒåº¦å™¨
â”œâ”€â”€ requirements.txt              # ä¾èµ–æ¸…å•
â””â”€â”€ README.md                     # æœ¬æ–‡æ¡£
```

---

## ğŸ—ºï¸ è·¯çº¿å›¾

### âœ… V3 å·²å®Œæˆ
- [x] æ¨¡å—åŒ–æ•´åˆï¼ˆ3å±‚æ¶æ„ï¼‰
- [x] Mambaæ·±åº¦æ¨¡å‹
- [x] VICRegé¢„è®­ç»ƒ
- [x] ç¦»æ•£æ—¶é—´ç”Ÿå­˜åˆ†æ
- [x] äº‹ä»¶é©±åŠ¨å›æµ‹
- [x] ç™½ç›’+é»‘ç›’èåˆ
- [x] é€‚åº”æ€§ç­–ç•¥é˜ˆå€¼

---

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

### å¼€å‘æµç¨‹
1. Fork æœ¬ä»“åº“
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. æäº¤ Pull Request

### ä»£ç è§„èŒƒ
- éµå¾ª PEP 8
- ç±»å‹æç¤ºï¼ˆType Hintsï¼‰
- å®Œå–„çš„æ–‡æ¡£å­—ç¬¦ä¸²
- å•å…ƒæµ‹è¯•è¦†ç›–

---

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶

---

## âš ï¸ å…è´£å£°æ˜

**æœ¬é¡¹ç›®ä»…ä¾›å­¦æœ¯ç ”ç©¶å’ŒæŠ€æœ¯äº¤æµä½¿ç”¨ï¼Œä¸æ„æˆä»»ä½•æŠ•èµ„å»ºè®®ã€‚**

- é‡åŒ–äº¤æ˜“å­˜åœ¨æœ¬é‡‘æŸå¤±é£é™©
- å†å²æ”¶ç›Šä¸ä»£è¡¨æœªæ¥è¡¨ç°
- å®ç›˜å‰è¯·å……åˆ†å›æµ‹å’Œé£é™©è¯„ä¼°
- ä½œè€…ä¸å¯¹ä»»ä½•äº¤æ˜“æŸå¤±è´Ÿè´£

---

## ğŸ“ è”ç³»æ–¹å¼

- **Email**: xjjsaikou@gmail.com
- **GitHub**: [@xjjsaikou](https://github.com/xjjsaikou)

---

<div align="center">

**å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¯·ç»™ä¸ª â­ Starï¼**

Made with â¤ï¸ by xjjsaikou | Powered by Mamba + VICReg

</div>
